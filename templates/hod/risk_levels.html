{% extends "hod/base_hod.html" %}

{% block title %}Risk Level Analysis - SPAS{% endblock %}

{% block header_title %}Risk Level Analysis{% endblock %}
{% block header_subtitle %}Complete view of all classes - Performance & Risk Analysis{% endblock %}

{% block extra_css %}
<style>
    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        border-left: 5px solid;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .summary-card.critical { border-left-color: #dc3545; }
    .summary-card.high { border-left-color: #fd7e14; }
    .summary-card.average { border-left-color: #ffc107; }
    .summary-card.safe { border-left-color: #28a745; }
    .summary-card.best { border-left-color: #6f42c1; }
    
    .summary-number {
        font-size: 2.8rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 5px;
    }
    
    .summary-label {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .summary-percent {
        font-size: 1rem;
        color: #6c757d;
    }
    
    /* Risk Distribution Bar */
    .risk-distribution {
        display: flex;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
    }
    
    .risk-segment {
        height: 100%;
    }
    
    .risk-critical { background: #dc3545; }
    .risk-high { background: #fd7e14; }
    .risk-average { background: #ffc107; }
    .risk-safe { background: #28a745; }
    .risk-best { background: #6f42c1; }
    
    /* Semester Grid */
    .semester-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin: 30px 0;
    }
    
    .semester-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .semester-card:hover {
        transform: translateY(-3px);
        border-color: #6f42c1;
    }
    
    .semester-card.active {
        border: 2px solid #6f42c1;
        background: #f3e9ff;
    }
    
    .semester-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .semester-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #6f42c1;
    }
    
    .semester-badge {
        background: #6f42c1;
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
    }
    
    /* Analysis Grid */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .analysis-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f3e9ff;
    }
    
    .card-header h3 {
        color: #6f42c1;
        margin: 0;
        font-size: 1.1rem;
    }
    
    /* Filter Section */
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
    }
    
    .filter-form {
        width: 100%;
    }
    
    .filter-row {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        flex-wrap: wrap;
    }
    
    .filter-label {
        font-weight: 600;
        color: #6f42c1;
        min-width: 80px;
    }
    
    .filter-select {
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        color: #2c3e50;
        background: white;
        min-width: 200px;
        flex: 1;
    }
    
    .filter-select:focus {
        border-color: #6f42c1;
        outline: none;
    }
    
    /* Risk Tabs */
    .risk-tabs {
        display: flex;
        gap: 10px;
        margin: 25px 0;
        flex-wrap: wrap;
        background: white;
        padding: 15px;
        border-radius: 50px;
        border: 1px solid #e9ecef;
    }
    
    .risk-tab {
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background: transparent;
        color: #6c757d;
        transition: all 0.3s;
    }
    
    .risk-tab:hover {
        background: #f8f9fa;
    }
    
    .risk-tab.active {
        color: white;
    }
    
    .risk-tab.critical.active { background: #dc3545; }
    .risk-tab.high.active { background: #fd7e14; }
    .risk-tab.average.active { background: #ffc107; color: #2c3e50; }
    .risk-tab.safe.active { background: #28a745; }
    .risk-tab.best.active { background: #6f42c1; }
    
    /* Student Cards */
    .student-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid;
        transition: all 0.3s;
    }
    
    .student-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .student-card.critical { border-left-color: #dc3545; background: #fff5f5; }
    .student-card.high { border-left-color: #fd7e14; background: #fff3e0; }
    .student-card.average { border-left-color: #ffc107; background: #fff9e6; }
    .student-card.safe { border-left-color: #28a745; background: #f0fff4; }
    .student-card.best { border-left-color: #6f42c1; background: #f3e9ff; }
    
    .student-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .student-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .student-reg {
        color: #6c757d;
        font-size: 0.9rem;
        margin-left: 5px;
    }
    
    .student-marks {
        font-weight: 700;
        min-width: 60px;
    }
    
    .student-attendance {
        font-size: 0.9rem;
        padding: 2px 8px;
        border-radius: 12px;
        background: #f8f9fa;
        min-width: 50px;
        text-align: center;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 50px;
        background: #f8f9fa;
        border-radius: 12px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .semester-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="summary-cards">
    <div class="summary-card critical">
        <div class="summary-number text-danger">{{ total_critical }}</div>
        <div class="summary-label">Critical</div>
        <div class="summary-percent">{{ (total_critical / total_students * 100)|round(1) if total_students > 0 else 0 }}%</div>
    </div>
    
    <div class="summary-card safe">
        <div class="summary-number text-success">{{ total_safe }}</div>
        <div class="summary-label">Safe</div>
        <div class="summary-percent">{{ (total_safe / total_students * 100)|round(1) if total_students > 0 else 0 }}%</div>
    </div>
    <div class="summary-card best">
        <div class="summary-number text-purple">{{ total_best }}</div>
        <div class="summary-label">Best</div>
        <div class="summary-percent">{{ (total_best / total_students * 100)|round(1) if total_students > 0 else 0 }}%</div>
    </div>
</div>

<!-- Overall Risk Distribution -->
<div class="risk-distribution mb-4">
    <div class="risk-segment risk-critical" style="width: {{ (total_critical / total_students * 100)|round if total_students > 0 else 0 }}%" 
         title="Critical: {{ total_critical }} students"></div>
    <div class="risk-segment risk-high" style="width: {{ (total_high_risk / total_students * 100)|round if total_students > 0 else 0 }}%" 
         title="High Risk: {{ total_high_risk }} students"></div>
    <div class="risk-segment risk-average" style="width: {{ (total_average / total_students * 100)|round if total_students > 0 else 0 }}%" 
         title="Average: {{ total_average }} students"></div>
    <div class="risk-segment risk-safe" style="width: {{ (total_safe / total_students * 100)|round if total_students > 0 else 0 }}%" 
         title="Safe: {{ total_safe }} students"></div>
    <div class="risk-segment risk-best" style="width: {{ (total_best / total_students * 100)|round if total_students > 0 else 0 }}%" 
         title="Best: {{ total_best }} students"></div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form method="GET" action="{{ url_for('hod.risk_levels') }}" class="filter-form">
        <div class="filter-row">
            <div class="filter-group">
                <span class="filter-label"><i class="fas fa-filter me-2"></i>Filter:</span>
                
                <select name="semester" class="filter-select" onchange="this.form.submit()">
                    <option value="all" {% if selected_semester == 'all' %}selected{% endif %}>All Semesters</option>
                    {% for sem in semesters %}
                    <option value="{{ sem }}" {% if selected_semester == sem|string %}selected{% endif %}>
                        Semester {{ sem }}
                    </option>
                    {% endfor %}
                </select>
                
                <select name="subject" class="filter-select" onchange="this.form.submit()">
                    <option value="all" {% if selected_subject == 'all' %}selected{% endif %}>All Subjects</option>
                    {% for subject in all_subjects %}
                    <option value="{{ subject.id }}" {% if selected_subject == subject.id|string %}selected{% endif %}>
                        {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <a href="{{ url_for('hod.risk_levels') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-redo-alt me-1"></i>Reset
            </a>
        </div>
    </form>
</div>

<!-- Semester Cards -->
<h4 class="mb-3"><i class="fas fa-layer-group me-2 text-purple"></i>Classes Overview</h4>
<div class="semester-grid">
    {% for sem in range(1, 9) %}
    {% set data = semester_data[sem] %}
    {% if data.total > 0 %}
    <div class="semester-card {% if selected_semester == sem|string %}active{% endif %}" 
         onclick="window.location.href='?semester={{ sem }}'">
        <div class="semester-header">
            <span class="semester-title">Semester {{ sem }}</span>
            <span class="semester-badge">{{ data.total }} Students</span>
        </div>
        
        <div class="risk-distribution">
            <div class="risk-segment risk-critical" style="width: {{ (data.critical / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-high" style="width: {{ (data.high_risk / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-average" style="width: {{ (data.average / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-safe" style="width: {{ (data.safe / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-best" style="width: {{ (data.best / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
        </div>
        
        <div class="row mt-3">
            <div class="col-6">
                <small class="text-muted">Avg Marks</small>
                <div class="fw-bold">{{ data.avg_marks|round(1) }}/20</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Attendance</small>
                <div class="fw-bold">{{ data.avg_attendance|round(1) }}%</div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Subject-wise Analysis -->
<h4 class="mb-3"><i class="fas fa-book me-2 text-purple"></i>Subject-wise Risk Analysis</h4>
<div class="analysis-grid">
    {% for subject in all_subjects %}
    {% set data = subject_risk_data[subject.id] %}
    {% if data.total > 0 %}
    <div class="analysis-card">
        <div class="card-header">
            <h3>{{ subject.name }}</h3>
            <span class="badge bg-purple">{{ subject.code }}</span>
        </div>
        
        <div class="row mb-3">
            <div class="col-4 text-center">
                <div class="fw-bold fs-4">{{ data.total }}</div>
                <small class="text-muted">Students</small>
            </div>
            <div class="col-4 text-center">
                <div class="fw-bold fs-4">{{ data.avg_marks|round(1) }}</div>
                <small class="text-muted">Avg Marks</small>
            </div>
            <div class="col-4 text-center">
                <div class="fw-bold fs-4">{{ data.avg_attendance|round(1) }}%</div>
                <small class="text-muted">Attendance</small>
            </div>
        </div>
        
        <div class="risk-distribution">
            <div class="risk-segment risk-critical" style="width: {{ (data.critical / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-high" style="width: {{ (data.high_risk / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-average" style="width: {{ (data.average / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-safe" style="width: {{ (data.safe / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
            <div class="risk-segment risk-best" style="width: {{ (data.best / data.total * 100)|round if data.total > 0 else 0 }}%"></div>
        </div>
        
        <div class="mt-3">
            <div class="d-flex justify-content-between">
                <span><span class="badge bg-danger">{{ data.critical }}</span> Critical</span>
                <span><span class="badge bg-warning">{{ data.high_risk }}</span> High</span>
                <span><span class="badge bg-info">{{ data.average }}</span> Avg</span>
                <span><span class="badge bg-success">{{ data.safe }}</span> Safe</span>
                <span><span class="badge bg-purple">{{ data.best }}</span> Best</span>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Risk Tabs -->
<h4 class="mb-3"><i class="fas fa-users me-2 text-purple"></i>Students by Risk Level</h4>
<div class="risk-tabs">
    <button class="risk-tab critical {% if critical|length > 0 %}active{% endif %}" onclick="showRiskTab('critical')" id="tabCritical">
        Critical ({{ critical|length }})
    </button>
    <button class="risk-tab high" onclick="showRiskTab('high')" id="tabHigh">
        High Risk ({{ high_risk|length }})
    </button>
    <button class="risk-tab average" onclick="showRiskTab('average')" id="tabAverage">
        Average ({{ average|length }})
    </button>
    <button class="risk-tab safe" onclick="showRiskTab('safe')" id="tabSafe">
        Safe ({{ safe|length }})
    </button>
    <button class="risk-tab best" onclick="showRiskTab('best')" id="tabBest">
        Best ({{ best|length }})
    </button>
</div>

<!-- Critical Section -->
<div id="criticalSection" class="risk-section">
    {% if critical %}
        {% for item in critical %}
        <div class="student-card critical">
            <div class="student-info">
                <div>
                    <span class="student-name">{{ item.student.name }}</span>
                    <span class="student-reg">{{ item.student.registration_number }}</span>
                    <span class="badge bg-secondary ms-2">Sem {{ item.student.current_semester }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="student-marks text-danger">{{ item.marks }}/20</span>
                    <span class="student-attendance">{{ item.attendance }}%</span>
                    <a href="/hod/student-detail/{{ item.student.id }}" class="btn btn-sm btn-outline-danger">View</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle text-success"></i>
            <h5>No Critical Risk Students</h5>
            <p>All students have attendance above 60% and marks above 10</p>
        </div>
    {% endif %}
</div>

<!-- High Risk Section -->
<div id="highSection" class="risk-section" style="display: none;">
    {% if high_risk %}
        {% for item in high_risk %}
        <div class="student-card high">
            <div class="student-info">
                <div>
                    <span class="student-name">{{ item.student.name }}</span>
                    <span class="student-reg">{{ item.student.registration_number }}</span>
                    <span class="badge bg-secondary ms-2">Sem {{ item.student.current_semester }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="student-marks text-warning">{{ item.marks }}/20</span>
                    <span class="student-attendance">{{ item.attendance }}%</span>
                    <a href="/hod/student-detail/{{ item.student.id }}" class="btn btn-sm btn-outline-warning">View</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-info-circle text-warning"></i>
            <h5>No High Risk Students</h5>
            <p>No students currently in high risk category</p>
        </div>
    {% endif %}
</div>

<!-- Average Section -->
<div id="averageSection" class="risk-section" style="display: none;">
    {% if average %}
        {% for item in average %}
        <div class="student-card average">
            <div class="student-info">
                <div>
                    <span class="student-name">{{ item.student.name }}</span>
                    <span class="student-reg">{{ item.student.registration_number }}</span>
                    <span class="badge bg-secondary ms-2">Sem {{ item.student.current_semester }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="student-marks">{{ item.marks }}/20</span>
                    <span class="student-attendance">{{ item.attendance }}%</span>
                    <a href="/hod/student-detail/{{ item.student.id }}" class="btn btn-sm btn-outline-info">View</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-line text-info"></i>
            <h5>No Average Students</h5>
            <p>No students currently in average category</p>
        </div>
    {% endif %}
</div>

<!-- Safe Section -->
<div id="safeSection" class="risk-section" style="display: none;">
    {% if safe %}
        {% for item in safe %}
        <div class="student-card safe">
            <div class="student-info">
                <div>
                    <span class="student-name">{{ item.student.name }}</span>
                    <span class="student-reg">{{ item.student.registration_number }}</span>
                    <span class="badge bg-secondary ms-2">Sem {{ item.student.current_semester }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="student-marks text-success">{{ item.marks }}/20</span>
                    <span class="student-attendance">{{ item.attendance }}%</span>
                    <a href="/hod/student-detail/{{ item.student.id }}" class="btn btn-sm btn-outline-success">View</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-shield-alt text-success"></i>
            <h5>No Safe Students</h5>
            <p>No students currently in safe category</p>
        </div>
    {% endif %}
</div>

<!-- Best Section -->
<div id="bestSection" class="risk-section" style="display: none;">
    {% if best %}
        {% for item in best %}
        <div class="student-card best">
            <div class="student-info">
                <div>
                    <span class="student-name">{{ item.student.name }}</span>
                    <span class="student-reg">{{ item.student.registration_number }}</span>
                    <span class="badge bg-secondary ms-2">Sem {{ item.student.current_semester }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="student-marks text-purple">{{ item.marks }}/20</span>
                    <span class="student-attendance">{{ item.attendance }}%</span>
                    <a href="/hod/student-detail/{{ item.student.id }}" class="btn btn-sm btn-outline-purple">View</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-star text-purple"></i>
            <h5>No Best Students</h5>
            <p>No students currently in best category</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function showRiskTab(tab) {
    document.querySelectorAll('.risk-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.risk-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tab + 'Section').style.display = 'block';
    document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// Show first non-empty category
document.addEventListener('DOMContentLoaded', function() {
    {% if critical|length > 0 %}
        showRiskTab('critical');
    {% elif high_risk|length > 0 %}
        showRiskTab('high');
    {% elif average|length > 0 %}
        showRiskTab('average');
    {% elif safe|length > 0 %}
        showRiskTab('safe');
    {% elif best|length > 0 %}
        showRiskTab('best');
    {% endif %}
});
</script>
{% endblock %}